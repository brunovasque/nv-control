name: Deploy nv-orchestrator-engine

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy with Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name nv-orchestrator-engine

      - name: Smoke test nv-orchestrator-engine
        shell: bash
        run: |
          set -euo pipefail

          url="https://nv-orchestrator-engine.brunovasque.workers.dev/orchestrator/workflows/save"
          body_file="$(mktemp)"

          status_code="$(curl -sS -o "$body_file" -w "%{http_code}" \
            -X POST "$url" \
            -H 'content-type: application/json' \
            --data '{}')"

          echo "HTTP status: $status_code"
          echo "Response body:"
          cat "$body_file"
          echo

          if grep -qi 'hello world' "$body_file"; then
            echo "Smoke test failed: response still contains Hello World"
            exit 1
          fi

          if grep -Eqi '<!doctype html|<html[[:space:]>]' "$body_file"; then
            echo "Smoke test failed: response appears to be HTML"
            exit 1
          fi

          case "$status_code" in
            200|400|405)
              echo "Smoke test passed with accepted status code $status_code"
              ;;
            *)
              echo "Smoke test failed: unexpected status code $status_code"
              exit 1
              ;;
          esac
